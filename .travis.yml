branches:
  only:
    - master
    - /^v\d+\.\d+/

notifications:
  slack:
    on_success: change
    secure: F4IjOE05MyaMOdPRL+r8qhs7jBvv4yDM3RmFKE1zNXnfUOqV4X38oQM1EI+YVsgpMQLj/pxnEB7wcTE4Bf86N6moLssEULCpvAuMVoXj4QbWdomLX+01WbFa6fLVeNQIg45NHrz2XzVBhoKOrMNnl+QI5mbR2AlS5oqsudHsXDnyLzZtd4Y5SDMdYG1zVWM01+oNNjgNfjcCGmOE/K0CnOMl6GPi3X9C34tJ19P2XT7MTDsz1/IfEF7fro2Q8DHEYL9dchJMoisXSkem5z7IDQkGzXsWdWT4NnndUvmd1MlTCE9qgoXDqRf95Qh8sB1Dz08HtvgfaosP2XjtNTfDI9BBYS15Ibw9y7PchAJE1luteNjF35EOy6OgmCLw/YpnweqfuNViBZz+yOPWXVC0kxnPIXKZ1wyH9ibeH6E4hr7a8o9SV/6SiWIlbYF+IR9jPXyTCLP/cc3sYljPWxDnhWFwFdRVIi3PbVAhVu7uWtVUO17Oc9gtGPgs/GrhOMkJfwQPXaudRJDpVZowxTX4x9kefNotlMAMRgq+Drbmgt4eEBiCNp0ITWgh17BiE1U09WS3myuduhoct85+FoVeaUkp1sxzHVtGsNQH0hcz7WcpZyOM+AwistJA/qzeEDQao5zi1eKWPbO2xAhi2rV1bDH6bPf/4lDBwLRqSiwvlWU=

os: linux
dist: bionic
language: minimal

jobs:
  include:
    - name: "Export Github Repositories"
      if: type in (push, api, cron)
      language: python
      git:
        depth: false
      script:
        - .travis/export-github-repo.sh web3.js/ test-solana-web3.js
        - .travis/export-github-repo.sh explorer/ test-explorer

    - &release-artifacts
      if: type in (push, api, cron)
      name: "macOS release artifacts"
      os: osx
      language: rust
      rust:
        - stable
      install:
        - source ci/rust-version.sh
      script:
        - source ci/env.sh
        - ci/publish-tarball.sh
      deploy:
        - provider: s3
          access_key_id: $AWS_ACCESS_KEY_ID
          secret_access_key: $AWS_SECRET_ACCESS_KEY
          bucket: release.solana.com
          region: us-west-1
          skip_cleanup: true
          acl: public_read
          local_dir: travis-s3-upload
          on:
            all_branches: true
        - provider: releases
          token: $GITHUB_TOKEN
          skip_cleanup: true
          file_glob: true
          file: travis-release-upload/*
          on:
            tags: true
    - <<: *release-artifacts
      name: "Linux release artifacts"
      os: linux
      before_install:
        - sudo apt-get install libssl-dev libudev-dev
    - <<: *release-artifacts
      name: "Windows release artifacts"
      os: windows

    # explorer pull request
    - name: "explorer"
      if: type = pull_request AND branch = master
      language: node_js
      node_js:
        - "node"

      before_install:
        - .travis/affects.sh explorer/ || travis_terminate 0
        - cd explorer

      script:
        - npm run build
        - npm run format

    # web3.js pull request
    - name: "web3.js"
      if: type = pull_request AND branch = master
      language: node_js
      node_js:
        - "lts/*"

      services:
        - docker

      cache:
        directories:
          - ~/.npm

      before_install:
        - .travis/affects.sh web3.js/ || travis_terminate 0
        - cd explorer

      script: echo todo
